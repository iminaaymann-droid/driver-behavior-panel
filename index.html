<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Driver Behavior Simulator ‚Äî Speedometer IoT (Interactive)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1724;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --hover:#3b82f6;
      --active:#1e40af;
      color-scheme:dark
    }
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Naskh Arabic',sans-serif;
      background:linear-gradient(180deg,#071020 0%,#0b1220 100%);
      color:#e6eef8
    }
    .app{
      display:grid;
      grid-template-columns:1fr 420px;
      gap:18px;
      padding:18px;
      max-width:1200px;
      margin:12px auto
    }
    .canvas-wrap{
      background:linear-gradient(180deg,#071029,#071018);
      border-radius:12px;
      padding:12px;
      box-shadow:0 6px 30px rgba(2,6,23,.6);
      position:relative;
      overflow:hidden
    }
    canvas{
      display:block;
      background:linear-gradient(180deg,#0e1530,#07102b);
      border-radius:8px;
      width:100%;
      height:640px
    }
    .panel{
      background:linear-gradient(180deg,#081224,#07101a);
      border-radius:12px;
      padding:14px;
      height:640px;
      box-shadow:0 6px 20px rgba(3,8,20,.6);
      overflow:auto
    }
    h2{
      margin:6px 0 12px 0;
      font-size:18px
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap
    }
    .btn{
      background:#0b1320;
      border:1px solid rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s ease;
      user-select:none;
    }
    .btn:hover{
      background:#0f1a2e;
      border-color:rgba(255,255,255,.1);
    }
    .btn:active{
      background:var(--active);
      transform:translateY(1px);
    }
    .btn.active{
      background:var(--accent);
      color:#041011;
      border-color:var(--accent);
    }
    .btn.primary{
      background:var(--accent);
      color:#041011;
    }
    .btn.warning{
      background:var(--warn);
      color:#1c1200;
    }
    .btn.danger{
      background:var(--danger);
      color:#1c0000;
    }
    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:13px
    }
    .stat{
      display:flex;
      justify-content:space-between;
      padding:8px 0;
      border-bottom:1px dashed rgba(255,255,255,.03)
    }
    .log{
      background:#071122;
      border-radius:8px;
      padding:8px;
      height:140px;
      overflow:auto;
      font-size:13px
    }
    .speed-box{
      display:flex;
      align-items:center;
      gap:12px
    }
    .gauge{
      width:120px;
      height:120px;
      border-radius:999px;
      background:linear-gradient(180deg,#081423,#031018);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:inset 0 -6px 20px rgba(0,0,0,.6);
      position:relative;
      overflow:hidden;
    }
    .gauge::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      border-radius:999px;
      background:conic-gradient(
        var(--accent) 0% 70%,
        var(--warn) 70% 85%,
        var(--danger) 85% 100%
      );
      opacity:0.1;
      z-index:0;
    }
    .speed-value{
      font-size:22px;
      font-weight:700;
      z-index:1;
    }
    label{
      display:block;
      font-size:13px;
      margin-top:8px
    }
    select,input{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:none;
      background:#061423;
      color:#e6eef8
    }
    .footer{
      margin-top:12px;
      font-size:13px;
      opacity:.85
    }
    .notice{
      padding:8px;
      border-radius:8px;
      background:linear-gradient(90deg,rgba(34,197,94,.08),rgba(96,165,250,.03));
      font-size:13px
    }
    .summary{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
      padding:8px;
      border-radius:8px;
      margin-top:10px
    }
    .row{
      display:flex;
      gap:8px
    }
    .row > div{
      flex:1
    }
    .small{
      font-size:12px;
      color:#a9c0d9
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px
    }
    .keyhint{
      font-size:12px;
      opacity:.8
    }
    .status-indicator{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      margin-right:6px;
    }
    .status-ok{
      background:var(--accent);
    }
    .status-warning{
      background:var(--warn);
    }
    .status-violation{
      background:var(--danger);
    }
    .road-markings{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }
    .marking{
      position:absolute;
      width:100%;
      height:2px;
      background:rgba(255,255,255,0.2);
    }
    .car-details{
      position:absolute;
      bottom:10px;
      left:10px;
      background:rgba(0,0,0,0.5);
      padding:8px;
      border-radius:6px;
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="canvas-wrap">
      <div class="topbar">
        <div class="badge">Driver Behavior Simulator ‚Äî Interactive</div>
        <div class="keyhint">Use arrows ‚Üê ‚Üí to steer, ‚Üë accelerate, ‚Üì brake. Space to toggle autopilot.</div>
      </div>
      <canvas id="road"></canvas>
    </div>

    <div class="panel">
      <h2>Controls & Live Data</h2>
      <div class="controls">
        <div class="btn" id="modeSafe">Safe</div>
        <div class="btn active" id="modeNormal">Normal</div>
        <div class="btn" id="modeAgg">Aggressive</div>
        <div class="btn primary" id="startBtn">Start Simulation</div>
        <div class="btn" id="stopBtn">Stop</div>
        <div class="btn" id="resetBtn">Reset</div>
      </div>

      <label>Trip Length (seconds)</label>
      <input type="number" id="tripLen" value="60" min="10" max="600" />

      <div class="row" style="margin-top:10px">
        <div>
          <div class="stat"><div>Mode</div><div id="modeLabel">Normal</div></div>
          <div class="stat"><div>Time</div><div id="timeLabel">0 s</div></div>
          <div class="stat"><div>Speed</div><div id="speedLabel">0 km/h</div></div>
          <div class="stat"><div>Max Speed</div><div id="maxLabel">0 km/h</div></div>
          <div class="stat"><div>Avg Speed</div><div id="avgLabel">0 km/h</div></div>
        </div>
        <div>
          <div class="gauge">
            <div style="text-align:center">
              <div class="small">Current</div>
              <div class="speed-value" id="gSpeed">0</div>
              <div class="small">km/h</div>
            </div>
          </div>
        </div>
      </div>

      <label>Speed Limit (for violation)</label>
      <input type="number" id="limit" value="120" />

      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1"><div class="btn" id="downloadCSV">Download CSV</div></div>
        <div style="flex:1"><div class="btn" id="summaryBtn">Show Summary</div></div>
      </div>

      <h2 style="margin-top:14px">Live Log</h2>
      <div class="log" id="log"></div>

      <div class="summary" id="finalSummary" style="display:none"></div>

      <div class="footer">
        <div class="notice"> Description: Control the car using the arrow keys. The program simulates a speedometer sensor, logs the readings, detects overspeeding events, and evaluates the driver's behavior.</div>
        <div style="margin-top:8px" class="small"> Export: You can download the CSV file containing all readings and use it in your project report or analysis.</div>
      </div>
    </div>
  </div>

<script>
// --- Simulation parameters & state ---
const canvas = document.getElementById('road');
const ctx = canvas.getContext('2d');
let W = 900, H = 640;
canvas.width = W; canvas.height = H;

let running = false;
let tripLength = Number(document.getElementById('tripLen').value) || 60; // seconds
let elapsed = 0;
let sampleInterval = 1.0; // seconds for logging
let sampleTimer = 0;
let logEl = document.getElementById('log');

const LIMIT = () => Number(document.getElementById('limit').value || 120);

// Modes
const MODES = {
  Safe: {name:'Safe', min:40, max:80, spike:100, accel:0.8, top:120},
  Normal: {name:'Normal', min:40, max:120, spike:150, accel:1.2, top:160},
  Aggressive: {name:'Aggressive', min:60, max:180, spike:220, accel:2.2, top:260}
};
let mode = MODES.Normal;

// Car physics state
let car = {
  x: W/2, y: H - 140, angle: -Math.PI/2, // facing up
  vx:0, vy:0, speed:0, // speed in km/h
  width:40, height:20,
  color: '#22c55e' // default color
};

let keyState = {left:false,right:false,up:false,down:false};
let autopilot = false;

// Logging
let readings = []; // {t, speed, status}
let overspeedCount = 0;
let maxSpeed = 0;

// helpers
function randRange(a,b){return a + Math.random()*(b-a)}
function kmhToPxPerSec(kmh){ // for visuals: assume 1 km/h ~ 0.28 px/sec (just for feel)
  return kmh * 0.28;
}

// --- UI wiring ---
function setMode(m){ 
  mode = MODES[m]; 
  document.getElementById('modeLabel').textContent = mode.name; 
  
  // Update button active states
  document.getElementById('modeSafe').classList.remove('active');
  document.getElementById('modeNormal').classList.remove('active');
  document.getElementById('modeAgg').classList.remove('active');
  document.getElementById('mode' + m).classList.add('active');
}
document.getElementById('modeSafe').onclick = ()=> setMode('Safe');
document.getElementById('modeNormal').onclick = ()=> setMode('Normal');
document.getElementById('modeAgg').onclick = ()=> setMode('Aggressive');

document.getElementById('startBtn').onclick = ()=> startSim();
document.getElementById('stopBtn').onclick = ()=> stopSim();
document.getElementById('resetBtn').onclick = ()=> resetSim();
document.getElementById('summaryBtn').onclick = ()=> showSummary();
document.getElementById('downloadCSV').onclick = ()=> downloadCSV();

// Add button click effects
document.querySelectorAll('.btn').forEach(btn => {
  btn.addEventListener('mousedown', function() {
    this.style.transform = 'translateY(2px)';
  });
  btn.addEventListener('mouseup', function() {
    this.style.transform = '';
  });
  btn.addEventListener('mouseleave', function() {
    this.style.transform = '';
  });
});

// keyboard
window.addEventListener('keydown',(e)=>{
  if(e.key === 'ArrowLeft') keyState.left = true;
  if(e.key === 'ArrowRight') keyState.right = true;
  if(e.key === 'ArrowUp') keyState.up = true;
  if(e.key === 'ArrowDown') keyState.down = true;
  if(e.key === ' ') { autopilot = !autopilot; e.preventDefault(); log((autopilot? 'Autopilot ON' : 'Autopilot OFF')) }
});
window.addEventListener('keyup',(e)=>{
  if(e.key === 'ArrowLeft') keyState.left = false;
  if(e.key === 'ArrowRight') keyState.right = false;
  if(e.key === 'ArrowUp') keyState.up = false;
  if(e.key === 'ArrowDown') keyState.down = false;
});

// --- Simulation control ---
function startSim(){
  if(running) return;
  tripLength = Number(document.getElementById('tripLen').value) || 60;
  running = true; elapsed = 0; sampleTimer = 0; readings = []; overspeedCount = 0; maxSpeed=0;
  log('Simulation started ‚Äî Mode: ' + mode.name);
  requestAnimationFrame(loop);
}
function stopSim(){ running = false; log('Simulation stopped'); }
function resetSim(){ 
  stopSim(); 
  elapsed = 0; 
  readings=[]; 
  overspeedCount=0; 
  maxSpeed=0; 
  car.x = W/2; 
  car.y = H-140; 
  car.speed = 0; 
  car.color = '#22c55e';
  document.getElementById('timeLabel').textContent='0 s'; 
  document.getElementById('finalSummary').style.display='none'; 
  log('Reset'); 
}

function log(msg){ 
  const line = document.createElement('div'); 
  
  // Add status indicator based on message content
  let statusClass = 'status-ok';
  if (msg.includes('VIOLATION')) statusClass = 'status-violation';
  else if (msg.includes('WARNING')) statusClass = 'status-warning';
  
  line.innerHTML = `<span class="status-indicator ${statusClass}"></span> ${msg}`; 
  logEl.prepend(line); 
  
  // Limit log entries
  if (logEl.children.length > 20) {
    logEl.removeChild(logEl.lastChild);
  }
}

// --- Driving behaviour: user control + mode influence ---
function modeTargetSpeed(){
  // when autopilot or no input, drift toward a typical speed in mode range
  const t = randRange(mode.min, mode.max);
  return t;
}

function updatePhysics(dt){
  // dt in seconds
  // steering
  if(keyState.left) car.angle -= 1.8 * dt;
  if(keyState.right) car.angle += 1.8 * dt;

  // acceleration control
  let acc = 0;
  if(autopilot){
    // drift towards mode center
    const target = (mode.min + mode.max)/2;
    if(car.speed < target) acc = mode.accel * 0.6; else acc = -mode.accel*0.3;
  } else {
    if(keyState.up) acc = mode.accel * 1.4;
    if(keyState.down) acc = -mode.accel * 2.2;
    // small natural braking
    if(!keyState.up && !keyState.down) acc = -0.6;
  }

  // random spikes for realism in non-safe modes
  if(mode.name !== 'Safe' && Math.random() < 0.01){
    acc += randRange(0, mode.accel*1.2);
  }

  // update speed
  car.speed += acc * dt * 10; // amplify for feel
  if(car.speed < 0) car.speed = 0;
  if(car.speed > mode.top) car.speed = mode.top + Math.random()*10; // cap

  // Update car color based on speed status
  if(car.speed > LIMIT()) {
    car.color = '#ef4444'; // Red for violation
  } else if(car.speed > LIMIT() - 20) {
    car.color = '#f59e0b'; // Yellow for warning
  } else {
    car.color = '#22c55e'; // Green for safe
  }

  // position update (visual only)
  const spx = kmhToPxPerSec(car.speed);
  car.x += Math.cos(car.angle) * spx * dt;
  car.y += Math.sin(car.angle) * spx * dt;
  // keep in bounds
  if(car.x < 60) car.x = 60; if(car.x > W-60) car.x = W-60;
  if(car.y < 60) car.y = 60; if(car.y > H-140) car.y = H-140;
}

// --- Logging and status detection ---
function sampleTick(){
  const t = Math.round(elapsed);
  const s = Math.round(car.speed);
  let status = 'OK';
  if(s > LIMIT()) { status = 'VIOLATION'; overspeedCount++; }
  else if(s > LIMIT() - 20) status = 'WARNING';
  readings.push({t, speed:s, status});
  if(s > maxSpeed) maxSpeed = s;
  document.getElementById('speedLabel').textContent = s + ' km/h';
  document.getElementById('gSpeed').textContent = s;
  document.getElementById('timeLabel').textContent = t + ' s';
  document.getElementById('maxLabel').textContent = maxSpeed + ' km/h';
  // average
  const avg = readings.reduce((a,b)=>a+b.speed,0)/(readings.length||1);
  document.getElementById('avgLabel').textContent = Math.round(avg) + ' km/h';

  // live log
  const short = `t=${t}s | Speed=${s} km/h | ${status}`;
  log(short);
}

// --- Summary ---
function showSummary(){
  if(readings.length === 0){ alert('No readings yet ‚Äî start simulation first.'); return; }
  const total = readings.length;
  const totalTime = Math.round(elapsed);
  const avg = Math.round(readings.reduce((a,b)=>a+b.speed,0)/total);
  const overs = readings.filter(r=>r.status==='VIOLATION').length;
  const percentOvers = Math.round(overs/total*100);
  let rating = 'Safe Driver';
  if(overs <= 1) rating = 'Safe Driver';
  else if(overs <= 5) rating = 'Medium Risk';
  else rating = 'üö® Dangerous Driver';

  const el = document.getElementById('finalSummary');
  el.style.display='block';
  el.innerHTML = `
    <strong>Trip Summary</strong>
    <div>Mode: ${mode.name}</div>
    <div>Total Time: ${totalTime} s</div>
    <div>Samples: ${total}</div>
    <div>Max Speed: ${maxSpeed} km/h</div>
    <div>Average Speed: ${avg} km/h</div>
    <div>Overspeed Violations: ${overs} (${percentOvers}%)</div>
    <div>Driver Rating: <strong>${rating}</strong></div>
    <div style="margin-top:8px;font-size:13px;color:#9fb8d9">Note: This is a software-only simulation representing a Speedometer + driver behavior assessment for a connected car.</div>
  `;
}

// CSV export
function downloadCSV(){
  if(readings.length === 0) { alert('No data to export'); return; }
  let csv = 'time_s,speed_kmh,status\n';
  readings.forEach(r=>{ csv += `${r.t},${r.speed},${r.status}\n` });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'speed_readings.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// --- Drawing ---
function drawScene(){
  ctx.clearRect(0,0,W,H);
  
  // draw road background with gradient
  const roadGradient = ctx.createLinearGradient(0, 0, 0, H);
  roadGradient.addColorStop(0, '#0a1533');
  roadGradient.addColorStop(1, '#07102b');
  ctx.fillStyle = roadGradient;
  ctx.fillRect(0,0,W,H);
  
  // draw lane markings
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 2;
  ctx.setLineDash([20, 20]);
  
  // Center line
  ctx.beginPath();
  ctx.moveTo(W/2, 0);
  ctx.lineTo(W/2, H);
  ctx.stroke();
  
  // Side lines
  ctx.beginPath();
  ctx.moveTo(60, 0);
  ctx.lineTo(60, H);
  ctx.stroke();
  
  ctx.beginPath();
  ctx.moveTo(W-60, 0);
  ctx.lineTo(W-60, H);
  ctx.stroke();
  
  ctx.setLineDash([]);

  // draw speed limit sign with better styling
  ctx.fillStyle='#1e293b';
  ctx.fillRect(W-130,20,110,70);
  ctx.strokeStyle='#334155';
  ctx.lineWidth=2;
  ctx.strokeRect(W-130,20,110,70);
  
  ctx.fillStyle='#f8fafc';
  ctx.font='bold 14px sans-serif';
  ctx.fillText('SPEED LIMIT', W-120, 42);
  
  ctx.font='bold 28px sans-serif';
  ctx.fillText(LIMIT(), W-105, 72);
  
  ctx.font='12px sans-serif';
  ctx.fillText('km/h', W-105, 85);

  // draw car with improved graphics
  ctx.save();
  ctx.translate(car.x, car.y);
  ctx.rotate(car.angle);
  
  // Car body with gradient
  const carGradient = ctx.createLinearGradient(-car.width/2, 0, car.width/2, 0);
  carGradient.addColorStop(0, car.color);
  carGradient.addColorStop(1, lightenColor(car.color, 30));
  
  ctx.fillStyle = carGradient;
  ctx.fillRect(-car.width/2, -car.height/2, car.width, car.height);
  
  // Car details
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.fillRect(-car.width/2 + 5, -car.height/2 + 5, car.width - 10, 8); // front hood
  
  // Windows
  ctx.fillStyle='rgba(30,41,59,0.8)';
  ctx.fillRect(-12, -10, 24, 12);
  
  // Headlights
  ctx.fillStyle='#fef3c7';
  ctx.fillRect(-18, -8, 4, 4);
  ctx.fillRect(14, -8, 4, 4);
  
  // Taillights
  ctx.fillStyle='#ef4444';
  ctx.fillRect(-18, 8, 4, 4);
  ctx.fillRect(14, 8, 4, 4);
  
  // Wheels with better styling
  ctx.fillStyle='#0f172a';
  ctx.fillRect(-18, -12, 8, 4);
  ctx.fillRect(10, -12, 8, 4);
  ctx.fillRect(-18, 8, 8, 4);
  ctx.fillRect(10, 8, 8, 4);
  
  // Wheel hubs
  ctx.fillStyle='#475569';
  ctx.fillRect(-16, -11, 4, 2);
  ctx.fillRect(12, -11, 4, 2);
  ctx.fillRect(-16, 9, 4, 2);
  ctx.fillRect(12, 9, 4, 2);
  
  ctx.restore();
  
  // Draw car info
  ctx.fillStyle = 'rgba(15,23,42,0.8)';
  ctx.fillRect(10, H-40, 180, 30);
  ctx.fillStyle = '#e2e8f0';
  ctx.font = '12px sans-serif';
  ctx.fillText(`Speed: ${Math.round(car.speed)} km/h | Status: ${getStatusText()}`, 20, H-20);
}

function getStatusText() {
  if (car.speed > LIMIT()) return 'VIOLATION';
  if (car.speed > LIMIT() - 20) return 'WARNING';
  return 'SAFE';
}

function lightenColor(color, percent) {
  // Convert hex to RGB
  let r = parseInt(color.substring(1, 3), 16);
  let g = parseInt(color.substring(3, 5), 16);
  let b = parseInt(color.substring(5, 7), 16);
  
  // Lighten
  r = Math.min(255, r + (255 - r) * (percent / 100));
  g = Math.min(255, g + (255 - g) * (percent / 100));
  b = Math.min(255, b + (255 - b) * (percent / 100));
  
  // Convert back to hex
  return `#${Math.round(r).toString(16).padStart(2, '0')}${Math.round(g).toString(16).padStart(2, '0')}${Math.round(b).toString(16).padStart(2, '0')}`;
}

// --- main loop ---
let last = performance.now();
function loop(now){
  if(!running) return;
  const dt = Math.min((now - last)/1000, 0.1); last = now;
  elapsed += dt; sampleTimer += dt;

  updatePhysics(dt);
  drawScene();

  // sampling each second
  if(sampleTimer >= sampleInterval){ sampleTick(); sampleTimer = 0; }

  // stop condition
  if(elapsed >= tripLength){ running = false; log('Trip finished'); showSummary(); }
  else requestAnimationFrame(loop);
}

// initial draw
function init(){ drawScene(); }
init();
</script>
</body>
</html>
