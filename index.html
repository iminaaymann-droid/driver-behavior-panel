<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Driver Behavior Panel ‚Äî Speedometer IoT</title>
  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --card:#020617;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      color-scheme:dark;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Naskh Arabic',sans-serif;
      background:radial-gradient(circle at top,#0f172a 0,#020617 55%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:12px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:radial-gradient(circle at top,#0b1120 0,#020617 55%);
      border-radius:16px;
      padding:14px;
      box-shadow:0 25px 60px rgba(15,23,42,.9);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .title{
      font-size:18px;
      font-weight:600;
    }
    .subtitle{
      font-size:11px;
      opacity:.8;
    }
    .badge{
      padding:4px 10px;
      border-radius:999px;
      background:rgba(34,197,94,.08);
      font-size:12px;
      border:1px solid rgba(34,197,94,.3);
    }
    .layout{
      display:grid;
      gap:10px;
      grid-template-columns:1.1fr 1fr;
    }
    @media (max-width: 900px){
      .layout{
        grid-template-columns:1fr;
      }
    }
    .card{
      background:radial-gradient(circle at top,#020617 0,#020617 55%);
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(148,163,184,.18);
    }
    h2{
      margin:0 0 8px 0;
      font-size:15px;
    }

    /* ------ canvas car area ----- */
    .canvas-wrap{
      position:relative;
      border-radius:14px;
      overflow:hidden;
    }
    #roadCanvas{
      width:100%;
      height:340px;
      border-radius:12px;
      display:block;
      background:linear-gradient(180deg,#020617,#020617);
    }
    .canvas-caption{
      position:absolute;
      top:8px;
      left:12px;
      font-size:11px;
      opacity:.85;
      background:rgba(15,23,42,.8);
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
    }

    .speed-display{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .gauge{
      width:130px;
      height:130px;
      border-radius:999px;
      background:conic-gradient(from 210deg,
        rgba(34,197,94,.15) 0deg,
        rgba(132,204,22,.18) 120deg,
        rgba(234,179,8,.18) 210deg,
        rgba(248,113,113,.30) 300deg);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .gauge-inner{
      width:96px;
      height:96px;
      border-radius:999px;
      background:radial-gradient(circle at top,#020617 0,#020617 55%);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      box-shadow:inset 0 8px 18px rgba(0,0,0,.7);
    }
    .label-small{
      font-size:11px;
      opacity:.8;
    }
    .speed-value{
      font-size:26px;
      font-weight:700;
    }
    .unit{
      font-size:11px;
      opacity:.7;
    }
    .indicator{
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid transparent;
    }
    .ind-safe{
      background:rgba(34,197,94,.08);
      border-color:rgba(34,197,94,.4);
      color:#bbf7d0;
    }
    .ind-warn{
      background:rgba(234,179,8,.08);
      border-color:rgba(234,179,8,.4);
      color:#facc15;
    }
    .ind-viol{
      background:rgba(248,113,113,.08);
      border-color:rgba(248,113,113,.5);
      color:#fecaca;
    }
    .pill{
      padding:4px 9px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      font-size:11px;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .pill-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#22c55e;
    }
    .stats{
      margin-top:8px;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      font-size:12px;
    }
    .stat-box{
      padding:6px 8px;
      border-radius:10px;
      background:rgba(15,23,42,.8);
      border:1px solid rgba(30,64,175,.4);
    }
    .stat-label{
      opacity:.7;
      font-size:11px;
    }
    .stat-value{
      font-size:14px;
      margin-top:2px;
    }

    .controls-main{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1;
      min-width:100px;
      padding:10px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:500;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      background:#020617;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.4);
    }
    .btn.primary{
      background:linear-gradient(120deg,#22c55e,#4ade80);
      color:#022c22;
      border:none;
    }
    .btn.danger{
      background:rgba(127,29,29,.4);
      border-color:rgba(248,113,113,.7);
    }
    .btn.secondary{
      background:rgba(15,23,42,.8);
    }

    label{
      font-size:12px;
      margin-bottom:4px;
      display:block;
      opacity:.9;
    }
    input[type="number"],input[type="range"]{
      width:100%;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      background:#020617;
      color:#e5e7eb;
      font-size:13px;
    }
    input[type="range"]{
      -webkit-appearance:none;
      height:6px;
      border-radius:999px;
      padding:0;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:18px;
      height:18px;
      border-radius:999px;
      background:#22c55e;
      border:2px solid #bbf7d0;
      margin-top:-6px;
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }

    .log{
      margin-top:6px;
      background:rgba(15,23,42,.9);
      border-radius:10px;
      padding:8px;
      font-size:11px;
      max-height:150px;
      overflow:auto;
      border:1px solid rgba(15,23,42,.9);
    }
    .log-line{
      margin-bottom:2px;
      opacity:.9;
      font-family:ui-monospace,Menlo,monospace;
    }
    .footer{
      font-size:11px;
      opacity:.8;
      margin-top:4px;
    }
    .summary{
      margin-top:8px;
      padding:8px;
      border-radius:10px;
      background:rgba(15,23,42,.9);
      border:1px dashed rgba(148,163,184,.5);
      font-size:12px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .chip{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.4);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">Driver Behavior Control Panel</div>
        <div class="subtitle">
          Mobile-friendly Speedometer + Overspeed Detection + Driver Scoring (IoT-style simulation) with car animation.
        </div>
      </div>
      <div class="badge">Speedometer Sensor ‚Äî Software Simulation</div>
    </div>

    <div class="layout">
      <!-- LEFT: road + speed/status -->
      <div>
        <div class="card canvas-wrap">
          <canvas id="roadCanvas"></canvas>
          <div class="canvas-caption">Car motion is linked to the simulated speed sensor readings.</div>
        </div>

        <div class="card" style="margin-top:8px">
          <h2>Speedometer & Status</h2>
          <div class="speed-display">
            <div class="gauge">
              <div class="gauge-inner">
                <div class="label-small">Current Speed</div>
                <div class="speed-value" id="speedVal">0</div>
                <div class="unit">km/h</div>
              </div>
            </div>
            <div>
              <div class="pill">
                <span class="pill-dot"></span>
                <span id="modeLabel">Mode: Normal</span>
              </div>
              <div style="margin-top:6px">
                <div class="label-small">Status</div>
                <div id="statusBadge" class="indicator ind-safe">
                  ‚óè Safe ‚Äî within limit
                </div>
              </div>
              <div class="stats">
                <div class="stat-box">
                  <div class="stat-label">Time</div>
                  <div class="stat-value" id="timeVal">0 s</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Speed Limit</div>
                  <div class="stat-value"><span id="limitVal">120</span> km/h</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Max Speed</div>
                  <div class="stat-value" id="maxVal">0 km/h</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Average Speed</div>
                  <div class="stat-value" id="avgVal">0 km/h</div>
                </div>
              </div>
            </div>
          </div>

          <div class="summary" id="summaryBox" style="display:none"></div>
        </div>
      </div>

      <!-- RIGHT: controls + log -->
      <div class="card">
        <h2>Controls & Data</h2>
        <div class="controls-main">
          <div class="row">
            <button class="btn primary" id="btnStart">Start</button>
            <button class="btn secondary" id="btnStop">Stop</button>
            <button class="btn" id="btnReset">Reset</button>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Trip Length (seconds)</label>
              <input type="number" id="tripLen" value="60" min="10" max="600">
            </div>
            <div style="flex:1">
              <label>Speed Limit</label>
              <input type="number" id="limitInput" value="120">
            </div>
          </div>

          <div>
            <label>Driving Aggressiveness (Mode)</label>
            <input type="range" id="modeSlider" min="1" max="3" step="1" value="2">
            <div class="chips">
              <div class="chip">1 = Safe</div>
              <div class="chip">2 = Normal</div>
              <div class="chip">3 = Aggressive</div>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="btnGas">Gas ‚Üë</button>
            <button class="btn" id="btnBrake">Brake ‚Üì</button>
          </div>

          <div class="row">
            <button class="btn secondary" id="btnAuto">Toggle Autopilot</button>
            <button class="btn" id="btnCSV">Download CSV</button>
          </div>
        </div>

        <div class="log" id="logBox"></div>

        <div class="footer">
          Description: The panel simulates a car speed sensor. Gas / Brake buttons control speed,
          the sensor logs readings every second, detects overspeeding, animates the car on a road,
          and produces a driver rating.
        </div>
      </div>
    </div>
  </div>

<script>
/* ----------- CANVAS (car + road) ------------- */
const roadCanvas = document.getElementById('roadCanvas');
const rctx = roadCanvas.getContext('2d');
function resizeCanvas(){
  roadCanvas.width = roadCanvas.clientWidth;
  roadCanvas.height = roadCanvas.clientHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

let carX = 0;
let laneOffset = 0; // ŸÑÿ™ÿ≠ÿ±ŸäŸÉ ÿßŸÑÿÆÿ∑Ÿàÿ∑

function drawRoad(currentSpeed, status){
  const w = roadCanvas.width;
  const h = roadCanvas.height;
  rctx.clearRect(0,0,w,h);

  // ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ∑ÿ±ŸäŸÇ
  if(status === 'VIOLATION'){
    rctx.fillStyle = '#111827';
  } else if(status === 'WARNING'){
    rctx.fillStyle = '#020617';
  } else {
    rctx.fillStyle = '#020617';
  }
  rctx.fillRect(0,0,w,h);

  // ÿ¨ÿßŸÜÿ®ŸäŸÜ ÿßŸÑÿ∑ÿ±ŸäŸÇ
  rctx.fillStyle = '#020617';
  rctx.fillRect(0,0, w, h);

  // ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ±ŸÖÿßÿØŸä
  rctx.fillStyle = '#020617';
  rctx.fillRect(w*0.15,0, w*0.7, h);

  // ÿÆÿ∑Ÿàÿ∑ ÿ¨ÿßŸÜÿ®Ÿäÿ©
  rctx.fillStyle = '#111827';
  rctx.fillRect(w*0.17,0, 4, h);
  rctx.fillRect(w*0.79,0, 4, h);

  // ÿÆÿ∑Ÿàÿ∑ ŸÖÿ™ŸÇÿ∑ÿπÿ© Ÿàÿ≥ÿ∑ ÿßŸÑÿ∑ÿ±ŸäŸÇ (ÿ®ÿ™ÿ™ÿ≠ÿ±ŸÉ ÿ≠ÿ≥ÿ® ÿßŸÑÿ≥ÿ±ÿπÿ©)
  const dashH = 26;
  const gap = 22;
  const midX = w*0.48;
  laneOffset += (currentSpeed/40); // ÿ£ÿ≥ÿ±ÿπ ŸÉŸÑŸÖÿß ÿßŸÑÿ≥ÿ±ÿπÿ© ÿ≤ÿßÿØÿ™
  if(laneOffset > (dashH+gap)) laneOffset = 0;

  rctx.fillStyle = 'rgba(248,250,252,0.6)';
  for(let y=-dashH; y < h+dashH; y += (dashH+gap)){
    rctx.fillRect(midX, y + laneOffset, 4, dashH);
  }

  // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸäŸÖŸäŸÜ/ÿ¥ŸÖÿßŸÑ ÿ®ÿ≥Ÿäÿ∑ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸàÿØ (ÿ®ÿ≥ ŸÖŸÜÿ∏ÿ±)
  const targetLane = status === 'VIOLATION' ? w*0.63 : (status === 'WARNING' ? w*0.52 : w*0.41);
  carX += (targetLane - carX) * 0.08;

  const carY = h*0.7;
  const carW = 60;
  const carH = 28;

  // ÿ∏ŸÑ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
  rctx.fillStyle = 'rgba(15,23,42,0.8)';
  rctx.beginPath();
  rctx.ellipse(carX+carW/2, carY+carH/2+6, carW*0.6, carH*0.5, 0, 0, Math.PI*2);
  rctx.fill();

  // ÿ¨ÿ≥ŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
  let carColor = '#22c55e';
  if(status === 'VIOLATION') carColor = '#ef4444';
  else if(status === 'WARNING') carColor = '#facc15';

  rctx.fillStyle = carColor;
  rctx.roundRect(carX, carY, carW, carH, 6);
  rctx.fill();

  // ÿ≤ÿ¨ÿßÿ¨
  rctx.fillStyle = 'rgba(15,23,42,0.9)';
  rctx.roundRect(carX+8, carY+4, carW-16, 10, 4);
  rctx.fill();

  // ÿπÿ¨ŸÑÿßÿ™
  rctx.fillStyle = '#020617';
  rctx.fillRect(carX+6, carY+carH-4, 12,4);
  rctx.fillRect(carX+carW-18, carY+carH-4, 12,4);
}

/* ÿ™ÿπÿØŸäŸÑ roundRect ŸÑŸà ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿ®ÿπÿ∂ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© */
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    if(typeof r === 'number') r = {tl:r,tr:r,br:r,bl:r};
    this.beginPath();
    this.moveTo(x+r.tl,y);
    this.lineTo(x+w-r.tr,y);
    this.quadraticCurveTo(x+w,y,x+w,y+r.tr);
    this.lineTo(x+w,y+h-r.br);
    this.quadraticCurveTo(x+w,y+h,x+w-r.br,y+h);
    this.lineTo(x+r.bl,y+h);
    this.quadraticCurveTo(x,y+h,x,y+h-r.bl);
    this.lineTo(x,y+r.tl);
    this.quadraticCurveTo(x,y,x+r.tl,y);
    this.closePath();
  }
}

/* ----------------- STATE ------------------- */
let running = false;
let elapsed = 0;
let sampleInterval = 1; // seconds
let sampleTimer = 0;
let speed = 0;          // km/h
let maxSpeed = 0;
let readings = [];      // {t, speed, status}
let overspeedCount = 0;
let autopilot = false;

const MODES = {
  1:{name:"Safe", accel:1,   naturalMax:80,  top:120},
  2:{name:"Normal", accel:1.7,naturalMax:120, top:170},
  3:{name:"Aggressive",accel:2.5,naturalMax:180, top:230}
};
let currentMode = MODES[2];

/* ----------------- ELEMENTS ------------------- */
const speedVal   = document.getElementById('speedVal');
const timeVal    = document.getElementById('timeVal');
const maxVal     = document.getElementById('maxVal');
const avgVal     = document.getElementById('avgVal');
const limitVal   = document.getElementById('limitVal');
const limitInput = document.getElementById('limitInput');
const btnStart   = document.getElementById('btnStart');
const btnStop    = document.getElementById('btnStop');
const btnReset   = document.getElementById('btnReset');
const btnGas     = document.getElementById('btnGas');
const btnBrake   = document.getElementById('btnBrake');
const btnCSV     = document.getElementById('btnCSV');
const btnAuto    = document.getElementById('btnAuto');
const tripLenEl  = document.getElementById('tripLen');
const slider     = document.getElementById('modeSlider');
const modeLabel  = document.getElementById('modeLabel');
const logBox     = document.getElementById('logBox');
const statusBadge= document.getElementById('statusBadge');
const summaryBox = document.getElementById('summaryBox');

function getLimit(){
  return Number(limitInput.value || 120);
}

/* ----------------- LOG ------------------- */
function log(msg){
  const line = document.createElement('div');
  line.className = 'log-line';
  line.textContent = msg;
  logBox.prepend(line);
}

/* ----------------- MODE ------------------- */
function updateMode(){
  const v = Number(slider.value);
  currentMode = MODES[v];
  modeLabel.textContent = 'Mode: ' + currentMode.name;
  log('Mode set to: ' + currentMode.name);
}
slider.addEventListener('input', updateMode);
limitInput.addEventListener('input', ()=>{ limitVal.textContent = getLimit(); });

/* ----------------- CONTROLS ------------------- */
btnStart.addEventListener('click', ()=>{
  if(running) return;
  running = true;
  elapsed = 0;
  sampleTimer = 0;
  readings = [];
  speed = 0;
  maxSpeed = 0;
  overspeedCount = 0;
  summaryBox.style.display = 'none';
  log('Simulation started');
  last = performance.now();
  requestAnimationFrame(loop);
});

btnStop.addEventListener('click', ()=>{
  if(!running) return;
  running = false;
  log('Simulation stopped');
});

btnReset.addEventListener('click', ()=>{
  running = false;
  elapsed = 0;
  speed = 0;
  maxSpeed = 0;
  readings = [];
  overspeedCount = 0;
  speedVal.textContent = '0';
  timeVal.textContent = '0 s';
  maxVal.textContent = '0 km/h';
  avgVal.textContent = '0 km/h';
  summaryBox.style.display = 'none';
  statusBadge.className = 'indicator ind-safe';
  statusBadge.textContent = '‚óè Safe ‚Äî within limit';
  log('Reset');
  drawRoad(0,'OK');
});

btnGas.addEventListener('click', ()=>{
  speed += currentMode.accel * 4;
  if(speed > currentMode.top) speed = currentMode.top;
  log('Gas pressed: speed ~ ' + Math.round(speed) + ' km/h');
});

btnBrake.addEventListener('click', ()=>{
  speed -= currentMode.accel * 6;
  if(speed < 0) speed = 0;
  log('Brake pressed: speed ~ ' + Math.round(speed) + ' km/h');
});

btnAuto.addEventListener('click', ()=>{
  autopilot = !autopilot;
  log(autopilot ? 'Autopilot ON' : 'Autopilot OFF');
});

btnCSV.addEventListener('click', ()=>{
  if(readings.length === 0){ alert('No data to export'); return; }
  let csv = 'time_s,speed_kmh,status\n';
  readings.forEach(r=>{
    csv += `${r.t},${r.speed},${r.status}\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'driver_speed_readings.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* ----------------- PHYSICS ------------------- */
function updatePhysics(dt){
  // drag
  speed -= 0.6 * dt * 10;
  if(speed < 0) speed = 0;

  if(autopilot){
    const target = currentMode.naturalMax;
    if(speed < target) speed += currentMode.accel * dt * 15;
    else speed -= currentMode.accel * dt * 8;
  }

  if(speed > currentMode.top) speed = currentMode.top + Math.random()*5;
}

/* ----------------- SAMPLING & STATUS ------------------- */
let lastStatus = 'OK';

function sample(){
  const t = Math.round(elapsed);
  const s = Math.round(speed);
  const limit = getLimit();
  let status = 'OK';

  if(s > limit) status = 'VIOLATION';
  else if(s > limit - 15) status = 'WARNING';

  readings.push({t, speed:s, status});
  if(s > maxSpeed) maxSpeed = s;

  speedVal.textContent = s;
  timeVal.textContent = t + ' s';
  maxVal.textContent = maxSpeed + ' km/h';
  const avg = readings.reduce((a,b)=>a+b.speed,0) / readings.length;
  avgVal.textContent = Math.round(avg) + ' km/h';

  if(status === 'OK'){
    statusBadge.className = 'indicator ind-safe';
    statusBadge.textContent = '‚óè Safe ‚Äî within limit';
  } else if(status === 'WARNING'){
    statusBadge.className = 'indicator ind-warn';
    statusBadge.textContent = '‚óè Near limit ‚Äî drive carefully';
  } else {
    statusBadge.className = 'indicator ind-viol';
    statusBadge.textContent = '‚óè Overspeed VIOLATION';
    overspeedCount++;
  }

  lastStatus = status;
  log(`t=${t}s | speed=${s} km/h | status=${status}`);
}

/* ----------------- SUMMARY ------------------- */
function showSummary(){
  if(readings.length === 0) return;
  const totalTime = Math.round(elapsed);
  const total = readings.length;
  const avg = Math.round(readings.reduce((a,b)=>a+b.speed,0) / total);
  const overs = readings.filter(r=>r.status === 'VIOLATION').length;
  const oversPct = Math.round(overs / total * 100);

  let rating = 'Safe Driver';
  if(overs <= 1) rating = 'Safe Driver';
  else if(overs <= 5) rating = 'Medium Risk';
  else rating = 'üö® Dangerous Driver';

  summaryBox.style.display = 'block';
  summaryBox.innerHTML = `
    <strong>Trip Summary</strong>
    <div>Total time: ${totalTime} s</div>
    <div>Samples: ${total}</div>
    <div>Max speed: ${maxSpeed} km/h</div>
    <div>Average speed: ${avg} km/h</div>
    <div>Overspeed violations: ${overs} (${oversPct}%)</div>
    <div>Driver rating: <strong>${rating}</strong></div>
    <div style="margin-top:6px;font-size:11px;opacity:.85">
      This panel represents a software-only Speedometer sensor in a connected car,
      with real-time monitoring, car motion visualization, and driver behavior scoring.
    </div>
  `;
}

/* ----------------- LOOP ------------------- */
let last = performance.now();
function loop(now){
  if(!running){
    drawRoad(speed,lastStatus);
    return;
  }
  const dt = Math.min((now - last)/1000,0.1);
  last = now;
  elapsed += dt;
  sampleTimer += dt;

  updatePhysics(dt);
  drawRoad(speed,lastStatus);

  if(sampleTimer >= sampleInterval){
    sample();
    sampleTimer = 0;
  }

  const tripLen = Number(tripLenEl.value || 60);
  if(elapsed >= tripLen){
    running = false;
    log('Trip finished');
    showSummary();
    drawRoad(speed,lastStatus);
    return;
  }

  requestAnimationFrame(loop);
}

// Init
updateMode();
limitVal.textContent = getLimit();
log('Ready. Set parameters then press Start.');
drawRoad(0,'OK');
</script>
</body>
</html>
